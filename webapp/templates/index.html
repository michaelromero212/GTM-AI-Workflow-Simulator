{% extends "layout.html" %}

{% block title %}Overview - GTM Ops{% endblock %}
{% block page_title %}Performance Overview{% endblock %}
{% block page_subtitle %}Real-time agent performance and GTM insights{% endblock %}

{% set active_page = 'home' %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <strong>Error loading data:</strong> {{ error }}
</div>
{% endif %}

{% if summary %}
<!-- Quick Actions -->
<div class="actions-grid">
    <a href="/upload" class="action-card">
        <div class="icon">üß™</div>
        <div class="label">Agent Lab</div>
        <div class="description">Test AI agents interactively</div>
    </a>
    <a href="/workflow" class="action-card">
        <div class="icon">üîÑ</div>
        <div class="label">Workflows</div>
        <div class="description">Map current vs future state</div>
    </a>
    <a href="/dashboard" class="action-card">
        <div class="icon">üìà</div>
        <div class="label">Dashboard</div>
        <div class="description">Deep KPI analytics</div>
    </a>
    <a href="/audit" class="action-card">
        <div class="icon">üõ°Ô∏è</div>
        <div class="label">Audit Log</div>
        <div class="description">Governance & compliance</div>
    </a>
</div>

<!-- Key Metrics -->
<div class="card">
    <div class="card-header">
        <h2>‚≠ê Key Metrics</h2>
        <p>{{ summary.total_runs|int }} total agent runs</p>
    </div>
    <div class="card-body">
        <div class="metrics-grid">
            <div class="metric-card success">
                <div class="metric-label">Acceptance Rate</div>
                <div class="metric-value"><span data-counter="{{ '%.1f'|format(summary.acceptance_rate) }}"
                        data-suffix="%" data-decimals="1">0</span></div>
                <div class="metric-change">User-validated accuracy</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Rating</div>
                <div class="metric-value"><span data-counter="{{ '%.2f'|format(summary.avg_rating) }}" data-suffix="/5"
                        data-decimals="2">0</span></div>
                <div class="metric-change">User satisfaction</div>
            </div>
            <div class="metric-card accent">
                <div class="metric-label">Hours Saved</div>
                <div class="metric-value"><span data-counter="{{ '%.1f'|format(summary.total_hours_saved) }}"
                        data-decimals="1">0</span></div>
                <div class="metric-change">Cumulative time recovered</div>
            </div>
            <div class="metric-card {% if summary.error_rate <= 5 %}success{% else %}danger{% endif %}">
                <div class="metric-label">Error Rate</div>
                <div class="metric-value"><span data-counter="{{ '%.1f'|format(summary.error_rate) }}" data-suffix="%"
                        data-decimals="1">0</span></div>
                <div class="metric-change">Target: ‚â§5%</div>
            </div>
        </div>
    </div>
</div>

<!-- A/B Test Summary -->
{% if by_version and by_version|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2>üîÄ A/B Test Summary</h2>
        <p>Agent version performance comparison</p>
    </div>
    <div class="card-body" style="padding:0;">
        <table>
            <thead>
                <tr>
                    <th>Version</th>
                    <th>Runs</th>
                    <th>Accuracy</th>
                    <th>Satisfaction</th>
                    <th>Avg Time</th>
                    <th>Error Rate</th>
                </tr>
            </thead>
            <tbody>
                {% for v in by_version %}
                <tr>
                    <td><span
                            class="badge {% if v.agent_version == 'A' %}badge-success{% else %}badge-warning{% endif %}">Agent
                            {{ v.agent_version }}</span></td>
                    <td>{{ v.total_tasks }}</td>
                    <td><span
                            class="badge {% if v.accuracy_pct >= 80 %}badge-success{% elif v.accuracy_pct >= 70 %}badge-warning{% else %}badge-danger{% endif %}">{{
                            "%.1f"|format(v.accuracy_pct) }}%</span></td>
                    <td>{{ "%.2f"|format(v.avg_satisfaction) }}/5</td>
                    <td>{{ "%.2f"|format(v.avg_resolution_time) }}s</td>
                    <td>{{ "%.1f"|format(v.error_rate) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Time Savings -->
{% if time_saved and time_saved|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2>‚è±Ô∏è Time Savings by Task</h2>
        <p>How much time AI agents save per task type</p>
    </div>
    <div class="card-body" style="padding:0;">
        <table>
            <thead>
                <tr>
                    <th>Task Type</th>
                    <th>Runs</th>
                    <th>Total Saved</th>
                    <th>Avg Saved/Run</th>
                    <th>Hours Saved</th>
                </tr>
            </thead>
            <tbody>
                {% for t in time_saved %}
                <tr>
                    <td><code>{{ t.task_type }}</code></td>
                    <td>{{ t.total_runs }}</td>
                    <td>{{ t.total_minutes_saved }} min</td>
                    <td>{{ t.avg_minutes_saved }} min</td>
                    <td><strong>{{ t.total_hours_saved }}h</strong></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Trend Chart -->
{% if trends and trends|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2>üìà Adoption Trend</h2>
    </div>
    <div class="card-body">
        <canvas id="overviewTrendChart" height="180"></canvas>
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
{% if trends and trends|length > 0 %}
<script>
    new Chart(document.getElementById('overviewTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for t in trends %}'{{ t.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Daily Runs',
            data: [{% for t in trends %}{{ t.total_tasks }}{% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#6366f1',
        backgroundColor: 'rgba(99,102,241,0.15)',
            fill: true,
                tension: 0.4,
                    pointRadius: 2
        }]
    },
    options: {
        responsive: true,
            plugins: { legend: { display: false } },
        scales: {
            y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#9ca3af' } },
            x: { grid: { display: false }, ticks: { color: '#9ca3af', maxTicksLimit: 8 } }
        }
    }
});
</script>
{% endif %}
{% endblock %}