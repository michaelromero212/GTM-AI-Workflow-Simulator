{% extends "layout.html" %}

{% block title %}Dashboard - GTM Ops{% endblock %}
{% block page_title %}KPI Dashboard{% endblock %}
{% block page_subtitle %}Comprehensive performance analytics{% endblock %}

{% set active_page = 'dashboard' %}

{% block content %}
{% if error %}
<div class="alert alert-danger">
    <strong>Error loading data:</strong> {{ error }}
</div>
{% else %}

{% if summary %}
<!-- North Star Metrics -->
<div class="card">
    <div class="card-header">
        <h2>‚≠ê North Star Metrics</h2>
    </div>
    <div class="card-body">
        <div class="metrics-grid">
            <div class="metric-card accent">
                <div class="metric-label">Total Runs</div>
                <div class="metric-value"><span data-counter="{{ summary.total_runs|int }}" data-decimals="0">0</span>
                </div>
                <div class="metric-change">Across all agent types</div>
            </div>
            <div class="metric-card success">
                <div class="metric-label">Acceptance Rate</div>
                <div class="metric-value"><span data-counter="{{ '%.1f'|format(summary.acceptance_rate) }}"
                        data-suffix="%" data-decimals="1">0</span></div>
                <div class="metric-change">User-validated accuracy</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Rating</div>
                <div class="metric-value"><span data-counter="{{ '%.2f'|format(summary.avg_rating) }}" data-suffix="/5"
                        data-decimals="2">0</span></div>
                <div class="metric-change">User satisfaction</div>
            </div>
            <div class="metric-card success">
                <div class="metric-label">Hours Saved</div>
                <div class="metric-value"><span data-counter="{{ '%.1f'|format(summary.total_hours_saved) }}"
                        data-suffix="h" data-decimals="1">0</span></div>
                <div class="metric-change">Cumulative time recovered</div>
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Funnel -->
{% if funnel %}
<div class="card">
    <div class="card-header">
        <h2>üìä Pipeline Funnel</h2>
        <p>Agent activity distribution across CRM stages</p>
    </div>
    <div class="card-body">
        <div class="funnel-chart">
            {% set max_count = funnel|map(attribute='count')|max %}
            {% for stage in funnel %}
            <div class="funnel-row">
                <div class="funnel-label">{{ stage.crm_stage }}</div>
                <div class="funnel-bar-container">
                    <div class="funnel-bar" style="width:{{ (stage.count / max_count * 100)|int }}%;">
                        <span class="funnel-count">{{ stage.count }}</span>
                    </div>
                </div>
                <div class="funnel-value">${{ "{:,.0f}".format(stage.total_value) }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Charts Row -->
<div class="dashboard-charts-grid responsive-grid-2">
    <!-- A/B Test Comparison -->
    {% if by_version and by_version|length > 0 %}
    <div class="card">
        <div class="card-header">
            <h2>üîÄ A/B Test Comparison</h2>
        </div>
        <div class="card-body">
            <div class="chart-wrapper">
                <canvas id="abChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Performance by Task Type -->
    {% if by_task and by_task|length > 0 %}
    <div class="card">
        <div class="card-header">
            <h2>üìã Performance by Task Type</h2>
        </div>
        <div class="card-body">
            <div class="chart-wrapper">
                <canvas id="taskChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Trends -->
{% if trends and trends|length > 0 %}
<div class="card">
    <div class="card-header">
        <h2>üìà Daily Trends</h2>
    </div>
    <div class="card-body">
        <div class="chart-wrapper chart-wrapper--wide">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>
</div>
{% endif %}

<!-- Operational Metrics -->
<div class="card">
    <div class="card-header">
        <h2>üìâ Safety & Guardrails</h2>
    </div>
    <div class="card-body">
        <div class="metrics-grid responsive-grid-4">
            <div class="metric-card {% if summary.error_rate <= 5 %}success{% else %}danger{% endif %}">
                <div class="metric-label">Error Rate</div>
                <div class="metric-value">{{ "%.1f"|format(summary.error_rate) }}%</div>
                <div class="metric-change">Target: ‚â§5%</div>
            </div>
            <div class="metric-card {% if summary.abstention_rate >= 3 %}success{% else %}warning{% endif %}">
                <div class="metric-label">Abstention Rate</div>
                <div class="metric-value">{{ "%.1f"|format(summary.abstention_rate) }}%</div>
                <div class="metric-change">Appropriate escalation</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Avg Resolution</div>
                <div class="metric-value">{{ "%.2f"|format(summary.avg_resolution_time) }}s</div>
                <div class="metric-change">Per agent task</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">Active Users</div>
                <div class="metric-value">{{ summary.unique_users|int }}</div>
                <div class="metric-change">Unique users</div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Runs Table -->
<div class="card">
    <div class="card-header">
        <h2>üìã Recent Agent Runs</h2>
        <p>Page {{ page }} of {{ total_pages }} ({{ total_runs }} total)</p>
    </div>
    <div class="card-body" style="padding:0; overflow-x:auto;">
        <table>
            <thead>
                <tr>
                    <th>Run ID</th>
                    <th>Timestamp</th>
                    <th>User</th>
                    <th>Task</th>
                    <th>Version</th>
                    <th>Accepted</th>
                    <th>Rating</th>
                    <th>Stage</th>
                </tr>
            </thead>
            <tbody>
                {% for run in runs %}
                <tr>
                    <td><code>{{ run.run_id }}</code></td>
                    <td>{{ run.timestamp }}</td>
                    <td>{{ run.user_id }}</td>
                    <td><code>{{ run.task_type }}</code></td>
                    <td><span
                            class="badge {% if run.agent_version == 'A' %}badge-success{% else %}badge-warning{% endif %}">{{
                            run.agent_version }}</span></td>
                    <td>{{ "‚úÖ" if run.user_accepted else "‚ùå" }}</td>
                    <td>{{ run.user_rating }}/5</td>
                    <td>{{ run.crm_stage }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <!-- Pagination -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="/dashboard?page={{ page - 1 }}&per_page={{ per_page }}" class="btn btn-outline">‚Üê Previous</a>
        {% endif %}
        <div class="pagination-info">
            <select onchange="window.location.href='/dashboard?page=1&per_page='+this.value" class="form-control"
                style="width:auto;display:inline-block;">
                {% for n in [10, 15, 25, 50] %}
                <option value="{{ n }}" {% if per_page==n %}selected{% endif %}>{{ n }} per page</option>
                {% endfor %}
            </select>
        </div>
        {% if page < total_pages %} <a href="/dashboard?page={{ page + 1 }}&per_page={{ per_page }}"
            class="btn btn-outline">Next ‚Üí</a>
            {% endif %}
    </div>
</div>

{% endif %}
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    {% if by_version and by_version | length > 0 %}
    new Chart(document.getElementById('abChart'), {
        type: 'bar',
        data: {
            labels: [{% for v in by_version %}'Agent {{ v.agent_version }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Accuracy %',
            data: [{% for v in by_version %}{{ "%.1f"| format(v.accuracy_pct) }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)'],
        borderRadius: 6
        }, {
        label: 'Avg Rating',
            data: [{% for v in by_version %}{{ "%.2f"|format(v.avg_satisfaction) }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['rgba(16, 185, 129, 0.3)', 'rgba(245, 158, 11, 0.3)'],
        borderRadius: 6
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { position: 'top', labels: { color: '#9ca3af' } } },
        scales: {
            y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#9ca3af' } },
            x: { grid: { display: false }, ticks: { color: '#9ca3af' } }
        }
    }
});
    {% endif %}

    {% if by_task and by_task | length > 0 %}
    new Chart(document.getElementById('taskChart'), {
        type: 'doughnut',
        data: {
            labels: [{% for t in by_task %}'{{ t.task_type }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for t in by_task %}{{ t.total_tasks }}{% if not loop.last %}, {% endif %} {% endfor %}],
    backgroundColor: ['#6366f1', '#10b981', '#f59e0b', '#ef4444'],
        borderWidth: 0
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { color: '#9ca3af', padding: 12 } } }
    }
});
    {% endif %}

    {% if trends and trends | length > 0 %}
    new Chart(document.getElementById('trendsChart'), {
        type: 'line',
        data: {
            labels: [{% for t in trends %}'{{ t.date }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            label: 'Tasks',
            data: [{% for t in trends %}{{ t.total_tasks }}{% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#6366f1',
        backgroundColor: 'rgba(99,102,241,0.1)',
            fill: true,
                tension: 0.4,
                    pointRadius: 2
        }, {
        label: 'Accuracy %',
            data: [{% for t in trends %}{{ "%.1f"|format(t.accuracy_pct) }}{% if not loop.last %}, {% endif %} {% endfor %}],
    borderColor: '#10b981',
        backgroundColor: 'rgba(16,185,129,0.1)',
            fill: true,
                tension: 0.4,
                    pointRadius: 2,
                        yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
        plugins: { legend: { position: 'top', labels: { color: '#9ca3af' } } },
        scales: {
            y: { grid: { color: 'rgba(255,255,255,0.06)' }, ticks: { color: '#9ca3af' } },
            y1: { position: 'right', grid: { display: false }, ticks: { color: '#9ca3af' }, min: 0, max: 100 },
            x: { grid: { display: false }, ticks: { color: '#9ca3af', maxTicksLimit: 10 } }
        }
    }
});
    {% endif %}
</script>
{% endblock %}